{"version":3,"sources":["../src/datasource.js"],"names":["_","Variables","Capabilities","QueryProcessor","HawkularDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","tenant","jsonData","token","q","typeResources","variables","capabilitiesPromise","queryVersion","then","version","queryProcessor","createHeaders","options","validTargets","targets","filter","target","hide","queryBy","tags","length","when","data","promises","map","run","all","flatten","concat","apply","responses","headers","Authorization","datasourceRequest","method","response","status","tenantFound","t","id","message","title","result","text","metric","value","key","hasOwnProperty","query","params","undefined","substr","findTags","trim","charAt","pattern","flatTags","property","tag","catch"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport {Variables} from './variables';\nimport {Capabilities} from './capabilities';\nimport {QueryProcessor} from './queryProcessor';\n\nexport class HawkularDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.tenant = instanceSettings.jsonData.tenant;\n    this.token = instanceSettings.jsonData.token;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.typeResources = {\n      \"gauge\": \"gauges\",\n      \"counter\": \"counters\",\n      \"availability\": \"availability\"\n    };\n    let variables = new Variables(templateSrv);\n    this.capabilitiesPromise = this.queryVersion()\n      .then(version => new Capabilities(version));\n    this.queryProcessor = new QueryProcessor($q, backendSrv, variables, this.capabilitiesPromise, this.url, this.createHeaders(), this.typeResources);\n  }\n\n  query(options) {\n    let validTargets = options.targets\n      .filter(target => !target.hide)\n      .filter(target => (target.queryBy === 'tags' && target.tags.length > 0) || target.target !== 'select metric');\n\n    if (validTargets.length === 0) {\n      return this.q.when({data: []});\n    }\n\n    let promises = validTargets.map(target => {\n      return this.queryProcessor.run(target, options);\n    });\n\n    return this.q.all(promises).then(responses => {\n      let flatten = [].concat.apply([], responses);\n      return {data: flatten};\n    });\n  }\n\n  createHeaders() {\n    var headers = {\n      'Content-Type': 'application/json',\n      'Hawkular-Tenant': this.tenant\n    };\n    if (typeof this.token === 'string' && this.token.length > 0) {\n      headers.Authorization = 'Bearer ' + this.token;\n    }\n    return headers;\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/tenants',\n      method: 'GET',\n      headers: this.createHeaders()\n    }).then(response => {\n      if (response.status === 200) {\n        let tenantFound = response.data.filter && response.data.filter(t => t.id === this.tenant).length > 0;\n        if (tenantFound) {\n          return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n        } else {\n          return { status: \"success\", message: \"Data source is working but the tenant could not be found\", title: \"Warning\" };\n        }\n      } else {\n        return { status: \"error\", message: \"Connection failed (\" + response.status + \")\", title: \"Error\" };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: options\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n  suggestQueries(target) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics?type=' + target.type,\n      method: 'GET',\n      headers: this.createHeaders()\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    });\n  }\n\n  suggestTags(type, key) {\n    if (!key) {\n      // Need at least some characters typed in order to suggest something\n      return this.q.when([]);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/' + this.typeResources[type] + '/tags/' + key + ':*',\n      method: 'GET',\n      headers: this.createHeaders()\n    }).then(result => {\n      if (result.data.hasOwnProperty(key)) {\n        return [' *'].concat(result.data[key]).map(value => {\n          return {text: value, value: value};\n        });\n      }\n      return [];\n    });\n  }\n\n  metricFindQuery(query) {\n    var params = \"\";\n    if (query !== undefined) {\n      if (query.substr(0, 5) === \"tags/\") {\n        return this.findTags(query.substr(5).trim());\n      }\n      if (query.charAt(0) === '?') {\n        params = query;\n      } else {\n        params = \"?\" + query;\n      }\n    }\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics' + params,\n      method: 'GET',\n      headers: this.createHeaders()\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    });\n  }\n\n  findTags(pattern) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics/tags/' + pattern,\n      method: 'GET',\n      headers: this.createHeaders()\n    }).then(result => {\n      var flatTags = [];\n      if (result.data) {\n        var data = result.data;\n        for (var property in data) {\n          if (data.hasOwnProperty(property)) {\n            flatTags = flatTags.concat(data[property]);\n          }\n        }\n      }\n      return flatTags.map(tag => {\n        return {text: tag, value: tag};\n      });\n    });\n  }\n\n  queryVersion() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/status',\n      method: 'GET',\n      headers: {'Content-Type': 'application/json'}\n    }).then(response => response.data['Implementation-Version'])\n    .catch(response => \"Unknown\");\n  }\n\n  getCapabilities() {\n    return this.capabilitiesPromise;\n  }\n}\n"]}